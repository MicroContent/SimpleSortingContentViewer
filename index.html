<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SimpleSortingViewer</title>
    <script type="application/javascript">
        function init() {
            window.data = getData();
            setXapiObjectGetter(getXapiObject);
            registerOnSubmitListener(onSubmit);
        }
        function updateLayout() {
            propagateLayoutChanges();
        }
        function sendStatement(stmt) {
            sendXapiStatement(stmt);
        }
    </script>
    <style type ="text/css">
        .answer {
            display: flex;
        }
        .answer > button {
            color: white;
            background-color: #3f51b5;
            margin-left: 5px;
            height: fit-content;
            border: 0px;
        }
        .hide {
            visibility: hidden;
        }
        .answertrue {
            background-color: green;
        }
        .answerfalse {
            background-color: red;
        }
    </style>
</head>
<body>
    <div id="question"></div>
    <div id="sortingContainer"></div>
    <div id="contextContainer">
        <button id="showContextHeader" class="btn btn-primary" onclick="showHideContext()"></button>
        <p id="contextContentContainer"></p>
    </div>

    <!-- for testing only -->
    <h1>testingfunction</h1><div id="testingfunction"></div>
    <!-- for testing only -->

    <script type="application/javascript">
        function getXapiObject(){
            return {
                "objectType": "Activity",
                // id is set by hosting application
                "id": undefined,
                "definition": {
                    "description": {
                        "en-US": window.data.question,
                        "de-AT": window.data.question
                    },
                    "type": "http://adlnet.gov/expapi/activities/cmi.interaction",
                    "interactionType": "sequencing",
                    "correctResponsesPattern": [
                        window.data.answers.reduce(function (acc, e, i) {
                                return (acc.length > 0) ? acc + "[,]" + (i+1) : (i+1)+"";
                            }, "")
                    ],
                    "choices": window.data.answers.map(function (e, i) {
                        return {
                            id: e.id.toString(),
                            description: {
                                "de-AT": e.value
                            }
                        }
                    }) 
                }
            }
        }
        
        function setQuestion() {
            document.getElementById('question').innerHTML = window.data.question;
        }

        function setSortingOptions(){
            //testingfunction(window.data.answers);
            document.getElementById('sortingContainer').innerHTML = window.data.answers.map(
                    function (cur, i) {
                        var buttonUp = '<button class="voteButton up'+cur.id+'" onclick="onMoveUp('+cur.id+')">+</button>';
                        var buttonDown = '<button class="voteButton down'+cur.id+'" onclick="onMoveDown('+cur.id+')">-</button>';
                        if (i==0) buttonUp = "";
                        if (i==(window.data.answers.length-1)) buttonDown = "";
                        return '<div id="answer'+ cur.id +'" class="answer">'+
                                '<p>' + (i+1) +'. </p>' +
                                '<p>' + cur.value +'</p>' +
                                buttonUp+
                                buttonDown+
                                '</div>';
                    }).reduce(function (acc, cur) {
                return acc + cur
            }, '');
        }

        function setContext(){
            document.getElementById('contextContentContainer').innerHTML =
                    isShowingSolution ? window.data.answerContext : window.data.questionContext;
            // we call showHide once to hide it for hint and to show it for explanation
            isContextShown = !isShowingSolution;
            showHideContext();
        }

        function onSubmit(){
            if (!isShowingSolution) {
                var allRight = true;
                allRight = checkIfCurrentAnswersCorrect();
                var stmt = {};
                // actor is set by hosting application
                stmt.actor = undefined;
                stmt.verb = {
                    "id": "http://adlnet.gov/expapi/verbs/answered",
                    "display": {
                        "de-DE": "beantwortete",
                        "en-US": "answered",
                        "fr-FR": "a répondu",
                        "es-ES": "contestó"
                    }
                };
                stmt.object = getXapiObject();
                stmt.result = {
                    response: window.data.answers.reduce(function (acc, e, i) {
                                return (acc.length > 0) ? acc + "[,]" + e.id : e.id+"";
                    }, ""),
                    success: allRight
                };
                sendStatement(stmt);
                isShowingSolution = true;

                //display answer state
                var answers = document.getElementsByClassName('answer');
                for (var i = 0; i < answers.length; i++) {
                   if (window.data.answers[i].id == (i+1)) answers[i].classList.add("answertrue");
                   else answers[i].classList.add("answerfalse");
                }

                //hide voting Buttons
                var votingButtons = document.getElementsByClassName('voteButton');
                for (var i = 0; i < votingButtons.length; i++) {
                   votingButtons[i].classList.add("hide"); 
                }
            }
            else {
                // remove classes and enable

                //remove answer state
                var answers = document.getElementsByClassName('answer');
                for (var i = 0; i < answers.length; i++) {
                   if (window.data.answers[i].id == (i+1)) answers[i].classList.remove("answertrue");
                   else answers[i].classList.remove("answerfalse");
                }

                // show voting buttons
                var votingButtons = document.getElementsByClassName('voteButton');
                for (var i = 0; i < votingButtons.length; i++) {
                   votingButtons[i].classList.remove("hide"); 
                }

                isShowingSolution = false;
            }
            setContext();
        }

        function onInteraction(){
            var stmt = {};
            // actor is set by hosting application
            stmt.actor = undefined;
            stmt.verb = {
                "id": "http://adlnet.gov/expapi/verbs/interacted",
                "display": {
                    "de-DE": "interagierte",
                    "en-US": "interacted",
                    "fr-FR": "a interagi",
                    "es-ES": "interactuó"
                }
            };
            stmt.object = getXapiObject();
            stmt.result = {
                response: window.data.answers.reduce(function (acc, e, i) {
                                return (acc.length > 0) ? acc + "[,]" + e.id : e.id+"";
                }, "")
            };
            sendStatement(stmt);
        }

        function onMoveUp(id){
            var position = findIndexOfArrayElement(window.data.answers, id); 
            window.data.answers = moveArrayElement(window.data.answers,position,position-1);
            setSortingOptions();
            onInteraction();
        }

        function onMoveDown(id){
            var position = findIndexOfArrayElement(window.data.answers, id); 
            window.data.answers = moveArrayElement(window.data.answers,position,position+1);
            setSortingOptions();
            onInteraction();
        }

        function showHideContext(){
            var ctxString = isShowingSolution ? 'Explanation' : 'Hint';
            if (isContextShown) {
                document.getElementById('showContextHeader').innerHTML = 'Show ' + ctxString;
                document.getElementById('contextContentContainer').setAttribute('hidden', '');
            } else {
                document.getElementById('showContextHeader').innerHTML = 'Hide ' + ctxString;
                document.getElementById('contextContentContainer').removeAttribute('hidden');
            }
            isContextShown = !isContextShown;
            updateLayout();
        }

        function moveArrayElement (array,from,to) {
            //to reorder 1 element in array
            array.splice(to,0,array.splice(from,1)[0]);
            return array;
        }

        function findIndexOfArrayElement (array, id) {
          for (var i = 0; i<array.length;i++) {
            if (array[i].id == id) return i; 
          }
          return -1;
        }

        function checkIfCurrentAnswersCorrect () {
            var current = window.data.answers.reduce(function (acc, e, i) {
                                return (acc.length > 0) ? acc + "[,]" + e.id : e.id+"";
                    }, "");
            var shouldBe = window.data.answers.reduce(function (acc, e, i) {
                                return (acc.length > 0) ? acc + "[,]" + (i+1) : (i+1)+"";
                            }, "");
            return !(Boolean(current.localeCompare(shouldBe)));
        } 

        function testingfunction (e) {
            // testingfunction for Testing only
            document.getElementById('testingfunction').innerHTML += JSON.stringify(e)+"<br>";
        }

        init();

        var isShowingSolution = false;
        var isContextShown = false;

        setQuestion();
        setSortingOptions();
        setContext();
    </script>
    <!-- 


        function onSubmit() {
            var checkboxLabels = document.getElementsByClassName('answerCheckboxLabel');
            var checkboxes = document.getElementsByClassName('answerCheckbox');
            if (!isShowingSolution) {
                var responses = [];
                var allRight = true;
                // assign classes and disable
                for (var i = 0; i < checkboxes.length; i++) {
                    var isChecked = checkboxes[i].checked;
                    var isCorrect = window.data.answers[i].correct;
                    allRight = allRight && (isChecked === isCorrect);
                    checkboxLabels[i].classList.add(isChecked ? (isCorrect ? 'truechecked' : 'falsechecked') : (isCorrect ? 'trueunchecked' : 'falseunchecked'));
                    checkboxes[i].setAttribute('disabled', 'true');
                    if (isChecked) {
                        responses.push(i.toString());
                    }
                }
                var stmt = {};
                // actor is set by hosting application
                stmt.actor = undefined;
                stmt.verb = {
                    "id": "http://adlnet.gov/expapi/verbs/answered",
                    "display": {
                        "de-DE": "beantwortete",
                        "en-US": "answered",
                        "fr-FR": "a répondu",
                        "es-ES": "contestó"
                    }
                };
                stmt.object = getXapiObject();
                stmt.result = {
                    response: responses.reduce(function (acc, e) {
                        return (acc.length > 0 && e.length > 0) ? acc + "[,]" + e : acc.length > 0 ? acc : e;
                    }, ""),
                    success: allRight
                };
                sendStatement(stmt);
                isShowingSolution = true;
            } else {
                // remove classes and enable
                for (var i = 0; i < checkboxes.length; i++) {
                    checkboxLabels[i].setAttribute('class', 'answerCheckboxLabel');
                    checkboxes[i].removeAttribute('disabled');
                }
                isShowingSolution = false;
            }
            setContext();
        }
        
    </script>


--> 

</body>
</html>